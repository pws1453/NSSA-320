---
- name: Wait for ADWS to Start
  ansible.windows.win_service:
    name: ADWS  
  register: adws_result
  retries: 30
  delay: 10
  until: adws_result.state == "running"

- name: Set Windows Domain Admins
  community.windows.win_domain_user:
    name: "{{ item.name|default(item) }}"
    password: "{{ default_password }}"
    state: present
    update_password: on_create
    domain_server: "{{ win_domain_name }}"
    domain_username: "Administrator@{{ win_domain_name }}"
    domain_password: "{{ default_password }}"
    groups_action: add
    upn: "{{ item.name|default(item) }}@{{ win_domain_name }}"
    groups:
      - Domain Admins
      - Enterprise Admins
      - Domain Users
      - Remote Management Users
      - Remote Desktop Users
  loop:
    "{{ win_domain_admins }}"

- name: Set Windows Domain Users
  community.windows.win_domain_user:
    name: "{{ item.name|default(item) }}"
    password: "{{ default_password}}"
    state: present
    update_password: on_create
    domain_server: "{{ win_domain_name }}"
    domain_username: "Administrator@{{ win_domain_name }}"
    domain_password: "{{ default_password }}"
    groups_action: add
    upn: "{{ item.name|default(item) }}@{{ win_domain_name }}"
    groups:
      - Domain Users
      - Remote Management Users
      - Remote Desktop Users
  loop:
    "{{ win_domain_users }}"

- name: Grant Logon Access to Domain Users
  ansible.windows.win_user_right:
    name: SeInteractiveLogonRight
    users:
      - "Domain Users"
    action: add